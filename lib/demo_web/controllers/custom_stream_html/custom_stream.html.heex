<.flash_group flash={@flash} /> 
<!-- NÃ³ lÃ  pháº§n chuyá»ƒn qua xem full list video stream -->
<a href="/videos" target="_blank"
  class="px-4 py-2 bg-green-500 text-white font-semibold rounded-lg shadow-md hover:bg-green-600 transition mr-3">
  List Video
</a>

<a href="/stream_key" target="_blank"
  class="px-4 py-2 bg-blue-500 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 transition mr-3">
  Stream key setting
</a>

<!-- NÃ³ lÃ  pháº§n táº£i video -->
<button id="convert-btn"
  class="px-4 py-2 bg-blue-500 text-white font-semibold rounded-lg shadow-md hover:bg-blue-600 transition">
  Chuyá»ƒn Ä‘á»•i vÃ  táº£i video
</button>

<p id="loading-text" class="hidden text-red-500 mt-2">Äang táº£i, vui lÃ²ng chá»...</p>

<a id="download-link" href="#" target="_blank"
  class="hidden px-4 py-2 bg-green-500 text-white font-semibold rounded-lg shadow-md hover:bg-green-600 transition">
  Táº£i video stream
</a>

<!-- Thá»±c hiá»‡n viá»‡c táº£i vÃ  check tráº¡ng thÃ¡i -->
<script>
  document.getElementById("convert-btn").addEventListener("click", async () => {
    let loadingText = document.getElementById("loading-text");
    let downloadLink = document.getElementById("download-link");

    loadingText.classList.remove("hidden"); // Hiá»‡n loading
    downloadLink.classList.add("hidden");   // áº¨n nÃºt táº£i

    // Gá»­i yÃªu cáº§u chuyá»ƒn Ä‘á»•i
    await fetch("/convert");

    // Kiá»ƒm tra liÃªn tá»¥c khi nÃ o video sáºµn sÃ ng
    let checkInterval = setInterval(async () => {
      let response = await fetch("/check_status");
      let result = await response.json();

      if (result.status === "done") {
        clearInterval(checkInterval);
        loadingText.classList.add("hidden"); // áº¨n loading
        downloadLink.href = result.download_url;
        downloadLink.classList.remove("hidden"); // Hiá»‡n nÃºt táº£i
      }
    }, 3000); // Kiá»ƒm tra má»—i 3 giÃ¢y
  });
</script>
<!-- NÃ³ lÃ  pháº§n upload video -->

<div class="max-w-md mx-auto p-6 bg-white rounded-2xl shadow-lg">
  <h1 class="text-2xl font-bold text-gray-800 mb-4">Upload Video</h1>

  <input type="text" id="titleInput" placeholder="Nháº­p tiÃªu Ä‘á»"
    class="block w-full px-4 py-2 mb-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none" />

  <textarea id="descriptionInput" placeholder="Nháº­p mÃ´ táº£"
    class="block w-full px-4 py-2 mb-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none"></textarea>

  <input type="file" id="fileInput" accept="video/*"
    class="block w-full text-sm text-gray-900 border border-gray-300 rounded-lg cursor-pointer bg-gray-50 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" />

  <button onclick="uploadAndSaveVideo()"
    class="mt-4 w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-xl transition">
    Upload & LÆ°u Video
  </button>

  <p id="status" class="mt-2 text-sm text-gray-600"></p>
</div>

<script>
  async function uploadAndSaveVideo() {
    console.log("ğŸš€ Báº¯t Ä‘áº§u upload video...");

    const fileInput = document.getElementById("fileInput");
    if (!fileInput.files.length) {
      alert("âš ï¸ Vui lÃ²ng chá»n video Ä‘á»ƒ upload!");
      return;
    }

    const file = fileInput.files[0];
    const title = document.getElementById("titleInput").value.trim();
    const description = document.getElementById("descriptionInput").value.trim();

    if (!title || !description) {
      alert("âš ï¸ Vui lÃ²ng nháº­p tiÃªu Ä‘á» vÃ  mÃ´ táº£!");
      return;
    }

    try {
      // 1ï¸âƒ£ Upload video lÃªn Cloudinary
      console.log("ğŸ“¡ Äang láº¥y URL upload tá»« Phoenix...");
      const res = await fetch("/api/get_upload_url", { method: "POST" });
      if (!res.ok) throw new Error(`âŒ Lá»—i láº¥y URL upload: ${res.statusText}`);

      const { upload_url, upload_preset } = await res.json();
      console.log("âœ… Upload URL:", upload_url);

      const formData = new FormData();
      formData.append("file", file);
      formData.append("upload_preset", upload_preset);

      console.log("ğŸš€ Äang upload video lÃªn Cloudinary...");
      const uploadRes = await fetch(upload_url, {
        method: "POST",
        body: formData
      });

      if (!uploadRes.ok) {
        const errorData = await uploadRes.json();
        throw new Error(`âŒ Lá»—i upload: ${JSON.stringify(errorData)}`);
      }

      const uploadData = await uploadRes.json();
      const uploadedVideoUrl = uploadData.secure_url;
      console.log("âœ… Upload thÃ nh cÃ´ng:", uploadedVideoUrl);

      // 2ï¸âƒ£ LÆ°u video vÃ o database
      console.log("ğŸ’¾ Äang lÆ°u video vÃ o database...");
      const saveRes = await fetch("/api/save_video", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ title, description, url: uploadedVideoUrl })
      });

      if (!saveRes.ok) {
        throw new Error(`âŒ Lá»—i tá»« server: ${saveRes.statusText}`);
      }

      const result = await saveRes.json();
      console.log("âœ… Káº¿t quáº£ lÆ°u:", result);

      if (result.status === "ok") {
        alert("ğŸ‰ Video Ä‘Ã£ Ä‘Æ°á»£c lÆ°u thÃ nh cÃ´ng!");
      } else {
        console.error("âŒ Lá»—i lÆ°u video:", result.errors);
        alert("âš ï¸ Lá»—i khi lÆ°u video. Kiá»ƒm tra láº¡i dá»¯ liá»‡u.");
      }
    } catch (error) {
      console.error("âŒ Lá»—i:", error);
      alert("âŒ Lá»—i khi táº£i lÃªn hoáº·c lÆ°u video!");
    }
  }

  // ğŸ–±ï¸ GÃ¡n sá»± kiá»‡n onclick cho nÃºt upload
  document.getElementById("uploadButton").onclick = uploadAndSaveVideo;

</script>




<%= live_render(@conn, DemoWeb.ConfirmLive) %>